<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التاجر شات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* style.css (مدمج مباشرة) */
        :root {
            --primary-color: #075e54; /* أخضر غامق (واتساب) */
            --secondary-color: #25d366; /* أخضر فاتح (واتساب) */
            --accent-color: #34b7f1; /* أزرق فاتح */
            --background-light: #ece5dd; /* خلفية واتساب فاتحة */
            --background-chat: #e5ddd5; /* خلفية الدردشة */
            --message-me: #dcf8c6; /* رسالتي */
            --message-other: #fff; /* رسالة الطرف الآخر */
            --text-dark: #333;
            --text-light: #666;
            --border-color: #ddd;
            --shadow-light: rgba(0, 0, 0, 0.15);
            --shadow-medium: rgba(0, 0, 0, 0.25);
            --error-color: #dc3545;
            --info-color: #17a2b8;
            --success-color: #28a745;
            --delivered-blue: #34b7f1; /* لون أزرق لعلامة التسليم */
        }

        body {
            font-family: 'Cairo', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom right, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--text-dark);
            direction: rtl;
            font-weight: bold;
            overflow-x: hidden; /* لمنع ظهور شريط التمرير الأفقي عند فتح القائمة الجانبية */
        }

        /* Ensure specific elements maintain desired font weights if not bolded by default */
        h2, h3, h4 {
            font-weight: bold;
        }
        button, label, .user, .message-content, .toast {
            font-weight: bold;
        }
        .message-info {
            font-weight: bold;
            font-size: 12px;
        }


        #app-container {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-medium);
            padding: 40px;
            width: 100%;
            max-width: 950px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            transition: all 0.4s ease-in-out;
            margin: 20px;
            z-index: 1; /* للتأكد من أنها فوق الخلفية ولكن تحت الأوفرلاي والسايدبار */
        }

        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-light);
            padding: 30px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        h2, h3, h4 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-weight: bold;
        }

        /* Auth Section Styling */
        #auth-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 40px;
            background: linear-gradient(to top left, #f8f9fa, #e9ecef);
            border-radius: 15px;
            box-shadow: 0 8px 25px var(--shadow-medium);
        }

        #auth-section .auth-header {
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #auth-section .auth-header h2 {
            font-size: 3em;
            margin-bottom: 10px;
            color: var(--primary-color);
            position: relative;
            animation: bounceIn 0.8s ease-out;
            font-weight: bold;
        }

        #auth-section .auth-header h2::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: var(--secondary-color);
            margin: 10px auto 0;
            border-radius: 2px;
        }

        #auth-section .auth-header p {
            font-size: 1.1em;
            color: var(--text-light);
            margin-top: 5px;
            font-weight: bold;
        }

        .input-group {
            width: 100%;
            max-width: 400px;
            margin-bottom: 15px;
            position: relative;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            transition: color 0.3s ease;
            font-size: 1.1em;
        }
        .input-group input {
            width: calc(100% - 40px);
            padding: 15px 15px 15px 45px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 17px;
            text-align: right;
            direction: rtl;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fcfcfc;
            font-weight: bold;
        }

        .input-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(7, 94, 84, 0.15);
            background-color: #fff;
        }
        .input-group input:focus + i {
            color: var(--primary-color);
        }

        .auth-buttons {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            width: 100%;
            justify-content: center;
        }

        button {
            padding: 14px 30px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            transition: background 0.3s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.3s ease;
            min-width: 150px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        button:hover {
            background: #064d45;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            color: var(--error-color);
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }
        .info-message {
            color: var(--info-color);
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        .loading-indicator {
            text-align: center;
            color: var(--text-light);
            font-style: normal;
            font-weight: bold;
            margin-top: 15px;
            font-size: 1.1em;
        }

        /* Chat Section Styling */
        #chat-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.6s ease-out;
            flex-grow: 1;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, var(--primary-color), #128c7e);
            padding: 18px 30px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/clean-textile.png');
            opacity: 0.1;
        }

        .chat-header h2 {
            color: white;
            margin: 0;
            font-size: 2em;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }
        .chat-header h2 i {
            font-size: 0.8em;
            color: var(--secondary-color);
        }

        .logout-btn {
            background: #dc3545;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 15;
            font-weight: bold;
            display: flex; /* لعرض الأيقونة والنص بجانب بعضهما */
            align-items: center;
            gap: 5px; /* مسافة بين الأيقونة والنص */
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* زر فتح قائمة المستخدمين (يظهر فقط على الشاشات الصغيرة) */
        .toggle-users-btn {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 1.2em;
            display: none; /* مخفي افتراضيا، يظهر في الميديا كويري */
            margin-right: 15px; /* مسافة بينه وبين عناصر الهيدر الأخرى */
            order: -1; /* يوضع في البداية عند استخدام الفليكس بوكس */
            min-width: unset; /* لإلغاء الـ min-width الافتراضي للأزرار */
            box-shadow: none;
        }
        .toggle-users-btn:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .chat-header .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }


        .main-content {
            display: flex;
            gap: 25px;
            flex-wrap: wrap; /* يسمح بالعناصر بالانتقال لسطر جديد */
            flex-grow: 1;
            position: relative; /* لتمكين وضع القائمة الجانبية بشكل مطلق داخلها */
        }

        .user-list-container {
            flex: 1;
            min-width: 280px;
            max-height: 550px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            background: #fdfdfd;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease; /* لعملية التحريك */
        }
        .user-list-container h4 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user {
            padding: 15px;
            background: #eef1f4;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease;
            font-weight: bold;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #e0e0e0;
        }

        .user:hover {
            background: var(--background-chat);
            transform: translateX(8px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .user.active {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transform: translateX(5px);
            border-color: var(--accent-color);
        }
        .user.active:hover {
            background: #2ea7e1;
            transform: translateX(8px);
        }

        .chat-area {
            flex: 3;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 350px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-light);
            padding: 20px;
        }
        #chatWith {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: var(--primary-color);
            text-align: center;
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
        }

        #chatBox {
            background: var(--background-chat);
            background-image: url('https://www.transparenttextures.com/patterns/clean-textile.png');
            background-repeat: repeat;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-grow: 1;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            scroll-behavior: smooth;
        }

        .message {
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 1px 2px var(--shadow-light);
            font-size: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            animation: slideInFromSide 0.3s ease-out;
            font-weight: bold;
        }

        .message-content {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .message-info {
            font-size: 11px;
            color: var(--text-light);
            text-align: end;
            margin-top: 3px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
        }

        .message-status-icon {
            font-size: 0.8em;
            color: var(--text-light);
        }

        .message-status-icon.delivered {
            color: var(--delivered-blue);
        }


        .me {
            background: var(--message-me);
            align-self: flex-end;
            margin-left: 20%;
            border-bottom-left-radius: 2px;
        }

        .other {
            background: var(--message-other);
            align-self: flex-start;
            margin-right: 20%;
            border: 1px solid #eee;
            border-bottom-right-radius: 2px;
        }

        /* Styling for file messages */
        .message .file-container {
            margin-top: 5px;
            background-color: rgba(0,0,0,0.05);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .message .file-container i {
            font-size: 1.5em;
            color: var(--primary-color);
        }
        .message .file-container span {
            font-size: 0.9em;
            color: var(--text-dark);
            font-weight: normal;
        }
        .message .file-container img,
        .message .file-container video {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 5px;
            display: block;
        }
        .message .file-container a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }
        .message .file-container a:hover {
            text-decoration: underline;
        }


        /* Input area for messages */
        .input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex-grow: 1;
            padding: 14px 20px;
            border: 1px solid var(--border-color);
            border-radius: 30px;
            font-size: 17px;
            outline: none;
            background: #fefefe;
            text-align: right;
            direction: rtl;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: bold;
        }

        #messageInput:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(7, 94, 84, 0.15);
        }

        .input-area button {
            background: var(--primary-color);
            border-radius: 50%;
            padding: 14px;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .input-area button.attach-btn {
            background: #6c757d; /* لون مختلف لزر المرفقات */
            font-size: 1.1em;
        }
        .input-area button.attach-btn:hover {
            background: #5a6268;
        }

        .input-area button i {
            color: white;
        }
        .input-area button:hover {
            background: #064d45;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        /* Modals Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: #fff;
            margin: auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(-30px);
            opacity: 0;
            animation: modalSlideIn 0.4s ease-out forwards;
        }

        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }


        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .modal-close-btn {
            color: #aaa;
            position: absolute;
            top: 20px;
            left: 25px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: var(--error-color);
            text-decoration: none;
            transform: scale(1.1);
        }

        .modal-content .input-group {
            margin-bottom: 20px;
        }
        .modal-content .auth-buttons {
            margin-top: 20px;
        }

        /* Confirm Signup Modal specific styles */
        #confirmSignupModal .modal-content {
            text-align: center;
            padding: 30px;
            max-width: 400px;
        }
        #confirmSignupModal h3 {
            font-size: 1.8em;
            margin-bottom: 15px;
            font-weight: bold;
        }
        #confirmSignupModal p {
            font-size: 1.1em;
            color: var(--text-dark);
            margin-bottom: 25px;
            line-height: 1.6;
            font-weight: bold;
        }
        #confirmSignupModal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        #confirmSignupModal .modal-buttons button {
            min-width: 120px;
        }
        #confirmSignupModal .modal-buttons .no-btn {
            background-color: #6c757d;
        }
        #confirmSignupModal .modal-buttons .no-btn:hover {
            background-color: #5a6268;
        }
        
        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 90%;
            align-items: center;
        }

        .toast {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(-20px);
            animation: slideInToast 0.5s forwards, fadeOutToast 0.5s 2.5s forwards;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            font-weight: bold;
        }
        .toast.success { background-color: var(--success-color); }
        .toast.info { background-color: var(--info-color); }
        .toast.error { background-color: var(--error-color); }


        @keyframes slideInToast {
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOutToast {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }


        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
            transition: background 0.3s ease;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #064d45;
        }


        /* Keyframe Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInFromSide {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .other {
            animation: slideInFromSide-other 0.3s ease-out;
        }
        @keyframes slideInFromSide-other {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Overlay for sidebar */
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999; /* أقل من السايدبار وأعلى من المحتوى */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in, visibility 0.3s ease-in;
        }
        body.sidebar-open #sidebar-overlay {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            #app-container {
                max-width: 750px;
                padding: 30px;
            }
            .user-list-container {
                min-width: 200px;
            }
            .chat-area {
                min-width: unset;
            }
            .message {
                max-width: 85%;
            }
            .me {
                margin-left: 15%;
            }
            .other {
                margin-right: 15%;
            }
            .chat-header h2 {
                font-size: 1.8em;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                align-items: flex-start;
                font-size: 15px;
            }
            #app-container {
                padding: 15px;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
                box-shadow: none;
            }
            .main-content {
                flex-direction: column; /* يظل عموديًا لكن السايدبار سيكون منفصلاً */
                gap: 15px;
            }
            .chat-area { /* الشات اريا ستأخذ عرضاً كاملاً */
                width: 100%;
                min-width: unset;
                height: calc(100vh - 180px);
                padding: 15px;
            }
            #chatBox {
                height: calc(100% - 90px);
                min-height: 200px;
                padding: 15px;
            }
            .auth-buttons {
                flex-direction: column;
                gap: 15px;
            }
            .auth-buttons button {
                width: 100%;
                font-size: 16px;
                padding: 12px 25px;
            }
            .message {
                max-width: 95%;
                font-size: 15px;
            }
            .me {
                margin-left: 5%;
            }
            .other {
                margin-right: 5%;
            }
            .chat-header {
                padding: 15px 20px;
                justify-content: space-between; /* للحفاظ على المسافات */
                display: flex; /* تأكد من الفليكس بوكس للعناصر في الهيدر */
            }
            .chat-header .header-controls {
                display: flex;
                align-items: center;
                gap: 10px;
                order: 1; /* الأزرار على اليسار (أو يمين الشاشة) */
            }
            .chat-header h2 {
                font-size: 1.4em;
                order: 2; /* العنوان في المنتصف */
                flex-grow: 1;
                text-align: center;
                justify-content: center; /* لتوسيط الأيقونة مع النص */
            }
            .logout-btn {
                padding: 7px 12px;
                font-size: 13px;
            }
            .modal-content {
                padding: 25px;
            }
            #toast-container {
                top: 10px;
                width: 95%;
            }
            .toast {
                font-size: 0.9em;
                padding: 10px 15px;
            }
            .input-group input {
                font-size: 16px;
                padding: 12px 12px 12px 40px;
            }
            .input-group label {
                font-size: 15px;
            }
            #chatWith {
                font-size: 1.3em;
            }

            /* User list as a sliding sidebar on mobile */
            .user-list-container {
                position: fixed;
                top: 0;
                right: -300px; /* مخفية خارج الشاشة على اليمين */
                width: 280px;
                height: 100%;
                z-index: 1001; /* أعلى من الأوفرلاي والمحتوى */
                background: #fdfdfd;
                box-shadow: 0 0 15px rgba(0,0,0,0.4);
                padding: 20px;
                padding-top: 80px; /* مسافة للابتعاد عن الهيدر */
                overflow-y: auto;
                transition: transform 0.3s ease-out;
            }
            /* إظهار زر فتح القائمة الجانبية */
            .toggle-users-btn {
                display: block; /* يظهر الزر في وضع الموبايل */
            }
            /* عند فتح السايدبار */
            body.sidebar-open .user-list-container {
                transform: translateX(-300px); /* تنزلق إلى اليسار لتظهر */
            }
            /* عند فتح السايدبار، اجعل محتوى التطبيق يتقلص قليلا أو يتأثر */
            body.sidebar-open #app-container {
                /* هذا الجزء قد يتسبب في مشاكل إذا لم يتم التعامل معه بحذر */
                /* transform: translateX(-150px); */ 
            }
        }

        /* تحسينات إضافية لجوال أفقي */
        @media (max-height: 500px) and (max-width: 800px) {
            .user-list-container {
                padding-top: 60px; /* Adjust for smaller header height */
                width: 250px; /* Slightly smaller sidebar for horizontal mobile */
            }
            body.sidebar-open .user-list-container {
                transform: translateX(-250px);
            }
            .chat-area {
                height: unset;
            }
            #chatBox {
                height: 180px;
                min-height: 150px;
            }
            #app-container {
                margin: 10px;
                padding: 15px;
            }
            .chat-header {
                padding: 12px 15px;
            }
            .chat-header h2 {
                font-size: 1.3em;
            }
            .logout-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

    </style>
</head>
<body>
    <div id="app-container">
        <section id="auth-section" class="card">
            <div class="auth-header">
                <h2>مرحبًا بك في التاجر شات <i class="fas fa-comments"></i></h2>
                <p>تواصل مع الآخرين بسهولة وأمان</p>
            </div>
            
            <p class="error-message" id="authErrorMessage"></p>

            <div class="input-group">
                <label for="username">اسم المستخدم:</label>
                <input type="text" id="username" placeholder="اسم المستخدم الخاص بك" autocomplete="username">
                <i class="fas fa-user"></i>
            </div>

            <div class="input-group">
                <label for="password">كلمة المرور:</label>
                <input type="password" id="password" placeholder="********" autocomplete="current-password">
                <i class="fas fa-lock"></i>
            </div>

            <div class="auth-buttons">
                <button id="signupButton">تسجيل مستخدم جديد</button>
                <button id="loginButton">تسجيل الدخول</button>
            </div>
            <p class="loading-indicator" id="authLoadingIndicator" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> جاري المعالجة...
            </p>
        </section>

        <section id="chat-section" style="display: none;">
            <div class="chat-header">
                <div class="header-controls">
                    <button id="toggleUsersListButton" class="toggle-users-btn"><i class="fas fa-bars"></i></button>
                    <button id="logoutButton" class="logout-btn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
                </div>
                <h2><i class="fas fa-headset"></i> التاجر شات</h2>
            </div>
            
            <h3 id="chatWith">اختر مستخدمًا لبدء المحادثة</h3>

            <div class="main-content">
                <div class="user-list-container card">
                    <h4><i class="fas fa-users"></i> المستخدمون المتوفرون</h4>
                    <div class="user-list" id="usersList">
                        </div>
                </div>

                <div class="chat-area card">
                    <div id="chatBox" class="chat-box">
                        </div>

                    <div class="input-area">
                        <input type="file" id="fileInput" style="display: none;" multiple accept="image/*, video/*, .pdf, .doc, .docx, .xls, .xlsx, .txt">
                        <button id="attachFileButton" class="attach-btn"><i class="fas fa-paperclip"></i></button>
                        
                        <input type="text" id="messageInput" placeholder="اكتب رسالتك...">
                        <button id="sendMessageButton"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h3>إنشاء حساب جديد</h3>
            <p class="info-message">
                <i class="fas fa-info-circle"></i> التعليمات: اسم المستخدم يجب أن يكون فريدًا، وكلمة المرور 6 أحرف أو أكثر.
            </p>
            <p class="error-message" id="signupModalErrorMessage"></p>

            <div class="input-group">
                <label for="modalUsername">اسم المستخدم:</label>
                <input type="text" id="modalUsername" placeholder="اسم المستخدم الفريد" autocomplete="new-username">
                <i class="fas fa-user-plus"></i>
            </div>

            <div class="input-group">
                <label for="modalPassword">كلمة المرور:</label>
                <input type="password" id="modalPassword" placeholder="كلمة مرور قوية (6+ أحرف)" autocomplete="new-password">
                <i class="fas fa-key"></i>
            </div>
            
            <div class="input-group">
                <label for="modalConfirmPassword">تأكيد كلمة المرور:</label>
                <input type="password" id="modalConfirmPassword" placeholder="أعد إدخال كلمة المرور" autocomplete="new-password">
                <i class="fas fa-key"></i>
            </div>

            <div class="auth-buttons">
                <button id="modalRegisterButton"><i class="fas fa-user-check"></i> تسجيل الآن</button>
            </div>
            <p class="loading-indicator" id="signupModalLoadingIndicator" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> جاري التسجيل...
            </p>
        </div>
    </div>

    <div id="confirmSignupModal" class="modal">
        <div class="modal-content">
            <h3>تأكيد إنشاء حساب</h3>
            <p>هل أنت متأكد من رغبتك في إنشاء حساب جديد؟</p>
            <p>هذا الحساب سيسمح لك بالتواصل مع المستخدمين الآخرين في التاجر شات.</p>
            <div class="modal-buttons">
                <button id="confirmYesBtn" class="primary-btn">نعم، أنا متأكد</button>
                <button id="confirmNoBtn" class="no-btn">لا، تراجع</button>
            </div>
        </div>
    </div>


    <div id="toast-container"></div>
    <div id="sidebar-overlay"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, query, orderBy, onSnapshot, getDocs, setDoc, getDoc, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // لتشفير كلمة المرور (مكتبة بسيطة في المتصفح)
        async function hashPassword(password) {
            const textEncoder = new TextEncoder();
            const data = textEncoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashedPassword;
        }

        // تهيئة Firebase - **تأكد من استبدال هذه القيم بقيم مشروعك الفعلية**
        const firebaseConfig = {
            apiKey: "AIzaSyCbQwZvbwWNte0IqrjGHABhQWwqgiRsLQ4", 
            authDomain: "altajer-2fb23.firebaseapp.com",
            projectId: "altajer-2fb23",
            storageBucket: "altajer-2fb23.appspot.com",
            messagingSenderId: "387131983810",
            appId: "1:387131983810:web:aa7340482eed919701785b",
            measurementId: "G-EVZPV0GR74"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // عناصر DOM الرئيسية
        const authSection = document.getElementById("auth-section");
        const chatSection = document.getElementById("chat-section");
        const authErrorMessage = document.getElementById("authErrorMessage");
        const authLoadingIndicator = document.getElementById("authLoadingIndicator");

        // عناصر قسم المصادقة
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const signupButton = document.getElementById("signupButton");
        const loginButton = document.getElementById("loginButton");

        // عناصر قسم الدردشة
        const logoutButton = document.getElementById("logoutButton");
        const usersListElement = document.getElementById("usersList");
        const chatWithElement = document.getElementById("chatWith");
        const chatBoxElement = document.getElementById("chatBox");
        const messageInput = document.getElementById("messageInput");
        const sendMessageButton = document.getElementById("sendMessageButton");

        // عناصر المودال (نافذة تسجيل مستخدم جديد)
        const signupModal = document.getElementById("signupModal");
        const signupModalCloseBtn = document.querySelector("#signupModal .modal-close-btn");
        const modalUsernameInput = document.getElementById("modalUsername");
        const modalPasswordInput = document.getElementById("modalPassword");
        const modalConfirmPasswordInput = document.getElementById("modalConfirmPassword");
        const modalRegisterButton = document.getElementById("modalRegisterButton");
        const signupModalErrorMessage = document.getElementById("signupModalErrorMessage");
        const signupModalLoadingIndicator = document.getElementById("signupModalLoadingIndicator");

        // عناصر مودال تأكيد التسجيل الجديد
        const confirmSignupModal = document.getElementById("confirmSignupModal");
        const confirmYesBtn = document.getElementById("confirmYesBtn");
        const confirmNoBtn = document.getElementById("confirmNoBtn");

        // عنصر حاوية الإشعارات
        const toastContainer = document.getElementById("toast-container");

        // عناصر زر الملفات الجديدة
        const fileInput = document.getElementById("fileInput");
        const attachFileButton = document.getElementById("attachFileButton");

        // عناصر القائمة الجانبية الجديدة (المستخدمين)
        const toggleUsersListButton = document.getElementById("toggleUsersListButton");
        const userListContainer = document.querySelector(".user-list-container");
        const sidebarOverlay = document.getElementById("sidebar-overlay");


        let currentChatUser = null;
        let unsubscribeFromChat = null;
        let currentUserId = null;
        let chatUsers = {};
        let selectedFiles = []; // لتخزين الملفات المحددة مؤقتًا


        // ===============================================
        // دوال مساعدة للواجهة
        // ===============================================

        function showSection(sectionId) {
            authSection.style.display = "none";
            chatSection.style.display = "none";

            if (sectionId === "auth") {
                authSection.style.display = "flex";
                usernameInput.value = '';
                passwordInput.value = '';
                clearAuthError();
                // تأكد من إخفاء القائمة الجانبية عند تسجيل الخروج
                if (document.body.classList.contains('sidebar-open')) {
                    toggleSidebar();
                }
            } else if (sectionId === "chat") {
                chatSection.style.display = "flex";
                loadUsers();
            }
        }

        function displayAuthError(message, isModal = false) {
            const errorElement = isModal ? signupModalErrorMessage : authErrorMessage;
            errorElement.textContent = message;
            errorElement.style.display = "block";
        }

        function clearAuthError(isModal = false) {
            const errorElement = isModal ? signupModalErrorMessage : authErrorMessage;
            errorElement.textContent = "";
            errorElement.style.display = "none";
        }

        function setAuthLoading(isLoading, isModal = false) {
            const loadingElement = isModal ? signupModalLoadingIndicator : authLoadingIndicator;
            const primaryButton = isModal ? modalRegisterButton : loginButton;
            const secondaryButton = signupButton;

            if (isLoading) {
                loadingElement.style.display = "block";
                primaryButton.disabled = true;
                if (!isModal) {
                    secondaryButton.disabled = true;
                }
            } else {
                loadingElement.style.display = "none";
                primaryButton.disabled = false;
                if (!isModal) {
                    secondaryButton.disabled = false;
                }
            }
        }

        function setMessageInputState(isEnabled) {
            messageInput.disabled = !isEnabled;
            sendMessageButton.disabled = !isEnabled;
            attachFileButton.disabled = !isEnabled; // تعطيل زر إرفاق الملف أيضاً
            if (isEnabled) {
                messageInput.focus();
            }
        }

        function showSignupModal() {
            clearAuthError(true);
            modalUsernameInput.value = '';
            modalPasswordInput.value = '';
            modalConfirmPasswordInput.value = '';
            signupModal.style.display = 'flex';
            signupModal.offsetWidth; 
            signupModal.classList.add('show');
        }

        function hideSignupModal() {
            signupModal.classList.remove('show');
            setTimeout(() => {
                signupModal.style.display = 'none';
            }, 300);
        }

        function showConfirmSignupModal() {
            confirmSignupModal.style.display = 'flex';
            confirmSignupModal.offsetWidth;
            confirmSignupModal.classList.add('show');
        }

        function hideConfirmSignupModal() {
            confirmSignupModal.classList.remove('show');
            setTimeout(() => {
                confirmSignupModal.style.display = 'none';
            }, 300);
        }

        function showToastNotification(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-bell"></i> ${message}`;
            toastContainer.appendChild(toast);

            toast.offsetWidth;

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function toggleSidebar() {
            document.body.classList.toggle('sidebar-open');
        }


        // ===============================================
        // دوال المصادقة (بناء يدوي)
        // ===============================================

        async function handleSignupLogic(isModalSignup = false) {
            clearAuthError(isModalSignup);
            setAuthLoading(true, isModalSignup);

            const username = isModalSignup ? modalUsernameInput.value.trim() : usernameInput.value.trim();
            const password = isModalSignup ? modalPasswordInput.value : passwordInput.value;
            const confirmPassword = isModalSignup ? modalConfirmPasswordInput.value : password;

            if (!username || !password) {
                displayAuthError("يرجى تعبئة جميع الحقول.", isModalSignup);
                setAuthLoading(false, isModalSignup);
                return;
            }
            if (username.length < 3) {
                displayAuthError("اسم المستخدم يجب أن يكون 3 أحرف على الأقل.", isModalSignup);
                setAuthLoading(false, isModalSignup);
                return;
            }
            if (password.length < 6) {
                displayAuthError("كلمة المرور يجب أن تكون 6 أحرف على الأقل.", isModalSignup);
                setAuthLoading(false, isModalSignup);
                return;
            }
            if (isModalSignup && password !== confirmPassword) {
                displayAuthError("كلمة المرور وتأكيد كلمة المرور غير متطابقين.", isModalSignup);
                setAuthLoading(false, isModalSignup);
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    displayAuthError("اسم المستخدم هذا مستخدم بالفعل.", isModalSignup);
                    setAuthLoading(false, isModalSignup);
                    return;
                }

                const hashedPassword = await hashPassword(password);
                const newUserRef = doc(usersRef);
                const newUserId = newUserRef.id;

                await setDoc(newUserRef, {
                    uid: newUserId,
                    username: username,
                    passwordHash: hashedPassword,
                    createdAt: new Date()
                });

                currentUserId = newUserId;
                localStorage.setItem("uid", currentUserId);
                if (isModalSignup) {
                    hideSignupModal();
                    showToastNotification("تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول.", "success");
                }
                showSection("chat");
            } catch (error) {
                console.error("Signup error:", error);
                displayAuthError("حدث خطأ أثناء التسجيل: " + error.message, isModalSignup);
            } finally {
                setAuthLoading(false, isModalSignup);
            }
        }

        async function handleLogin() {
            clearAuthError();
            setAuthLoading(true);

            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) {
                displayAuthError("يرجى تعبئة جميع الحقول.");
                setAuthLoading(false);
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    displayAuthError("اسم المستخدم أو كلمة المرور غير صحيحة.");
                    setAuthLoading(false);
                    return;
                }

                const userData = querySnapshot.docs[0].data();
                const storedPasswordHash = userData.passwordHash;
                const enteredPasswordHash = await hashPassword(password);

                if (storedPasswordHash === enteredPasswordHash) {
                    currentUserId = userData.uid;
                    localStorage.setItem("uid", currentUserId);
                    showSection("chat");
                    showToastNotification(`مرحباً بك مجدداً يا ${userData.username}!`, "info");
                } else {
                    displayAuthError("اسم المستخدم أو كلمة المرور غير صحيحة.");
                }
            } catch (error) {
                console.error("Login error:", error);
                displayAuthError("حدث خطأ أثناء تسجيل الدخول: " + error.message);
            } finally {
                setAuthLoading(false);
            }
        }

        async function handleLogout() {
            console.log("Attempting to log out...");
            try {
                if (unsubscribeFromChat) {
                    unsubscribeFromChat();
                    unsubscribeFromChat = null;
                    console.log("Unsubscribed from chat listener.");
                }

                localStorage.removeItem("uid");
                currentUserId = null;
                currentChatUser = null;
                chatUsers = {};
                selectedFiles = []; // مسح الملفات المحددة عند تسجيل الخروج
                console.log("User UID removed from localStorage.");

                chatBoxElement.innerHTML = '';
                chatWithElement.textContent = "اختر مستخدمًا لبدء المحادثة";
                usersListElement.innerHTML = '';
                
                showSection("auth");
                showToastNotification("تم تسجيل الخروج بنجاح.", "info");
                console.log("Logout successful! Redirecting to authentication section.");

            } catch (error) {
                console.error("Error logging out:", error);
                alert("فشل تسجيل الخروج: " + error.message);
            }
        }

        // ===============================================
        // دوال الدردشة
        // ===============================================

        async function loadUsers() {
            try {
                const currentUserUid = localStorage.getItem("uid");
                if (!currentUserUid) {
                    handleLogout();
                    return;
                }
                currentUserId = currentUserUid;

                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("username"));
                const querySnapshot = await getDocs(q);
                usersListElement.innerHTML = "";
                chatUsers = {};

                querySnapshot.forEach(docu => {
                    const user = docu.data();
                    if (user.uid !== currentUserUid) {
                        chatUsers[user.uid] = user;
                        const div = document.createElement("div");
                        div.className = "user";
                        div.textContent = user.username;
                        div.dataset.userId = user.uid;
                        div.addEventListener("click", () => {
                            openChatWith(user, div);
                            // إخفاء القائمة الجانبية بعد اختيار مستخدم على الموبايل
                            if (window.innerWidth <= 768 && document.body.classList.contains('sidebar-open')) {
                                toggleSidebar();
                            }
                        });
                        usersListElement.appendChild(div);
                    }
                });
            } catch (error) {
                console.error("خطأ في تحميل المستخدمين:", error);
                showToastNotification("فشل تحميل قائمة المستخدمين.", "error");
            }
        }

        function createMessageElement(data, currentUserUid) {
            const msg = document.createElement("div");
            msg.className = `message ${data.sender === currentUserUid ? "me" : "other"}`;

            const timestamp = data.createdAt ? new Date(data.createdAt.toDate()) : new Date();
            const timeString = timestamp.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            
            let statusIconHtml = '';
            if (data.sender === currentUserUid) {
                statusIconHtml = '<i class="fas fa-check-double message-status-icon delivered"></i>';
            }

            let messageContentHtml = '';

            if (data.type === 'text') {
                messageContentHtml = `<div class="message-content">${data.text}</div>`;
            } else if (data.type === 'file') {
                let fileHtml = '';
                if (data.fileType.startsWith('image/')) {
                    fileHtml = `<img src="${data.fileUrl}" alt="صورة ${data.fileName}" loading="lazy">`;
                } else if (data.fileType.startsWith('video/')) {
                    fileHtml = `<video src="${data.fileUrl}" controls preload="metadata" loading="lazy" style="max-width: 100%;"></video>`;
                } else {
                    // For other file types, display a link or a generic file icon
                    const fileIcon = getFileIcon(data.fileName);
                    fileHtml = `
                        <a href="${data.fileUrl}" target="_blank" download="${data.fileName}">
                            <i class="${fileIcon}"></i>
                            <span>${data.fileName}</span>
                        </a>
                    `;
                }
                
                messageContentHtml = `
                    <div class="message-content">
                        ${data.text ? `<p>${data.text}</p>` : ''}
                        <div class="file-container">
                            ${fileHtml}
                        </div>
                    </div>
                `;
            }

            msg.innerHTML = `
                ${messageContentHtml}
                <div class="message-info">
                    <span class="message-time">${timeString}</span>
                    ${statusIconHtml}
                </div>
            `;
            return msg;
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return 'fas fa-file-pdf';
                case 'doc':
                case 'docx': return 'fas fa-file-word';
                case 'xls':
                case 'xlsx': return 'fas fa-file-excel';
                case 'ppt':
                case 'pptx': return 'fas fa-file-powerpoint';
                case 'txt': return 'fas fa-file-alt';
                case 'zip':
                case 'rar': return 'fas fa-file-archive';
                case 'mp3':
                case 'wav': return 'fas fa-file-audio';
                default: return 'fas fa-file';
            }
        }


        function openChatWith(user, clickedElement) {
            document.querySelectorAll('.user').forEach(el => el.classList.remove('active'));
            if (clickedElement) {
                clickedElement.classList.add('active');
            }

            if (unsubscribeFromChat) {
                unsubscribeFromChat();
                unsubscribeFromChat = null;
            }

            currentChatUser = user;
            chatWithElement.textContent = `الدردشة مع ${user.username}`;
            chatBoxElement.innerHTML = "";
            setMessageInputState(true);
            selectedFiles = []; // مسح الملفات المحددة عند فتح محادثة جديدة
            updateSendMessageButtonState(); // تحديث حالة زر الإرسال


            const currentUserUid = localStorage.getItem("uid");
            const chatId = currentUserUid < user.uid ? `${currentUserUid}_${user.uid}` : `${user.uid}_${currentUserUid}`;
            const messagesRef = collection(db, "chats", chatId, "messages");
            const q = query(messagesRef, orderBy("createdAt"));

            unsubscribeFromChat = onSnapshot(q, (snapshot) => {
                const isAtBottom = chatBoxElement.scrollHeight - chatBoxElement.clientHeight <= chatBoxElement.scrollTop + 1;
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        const msgElement = createMessageElement(data, currentUserUid);
                        chatBoxElement.appendChild(msgElement);

                        if (data.sender !== currentUserUid && (currentChatUser ? data.sender !== currentChatUser.uid : true)) {
                            const senderUsername = chatUsers[data.sender] ? chatUsers[data.sender].username : "مستخدم مجهول";
                            let toastMessage = `رسالة جديدة من ${senderUsername}: `;
                            if (data.type === 'text') {
                                toastMessage += data.text.substring(0, 30) + (data.text.length > 30 ? '...' : '');
                            } else if (data.type === 'file') {
                                toastMessage += `ملف: ${data.fileName}`;
                            }
                            showToastNotification(toastMessage, "info");
                        }
                    }
                });
                if (isAtBottom) {
                    chatBoxElement.scrollTop = chatBoxElement.scrollHeight;
                }
            }, (error) => {
                console.error("خطأ في الاستماع للرسائل:", error);
                showToastNotification("فشل تحديث الرسائل.", "error");
            });
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && selectedFiles.length === 0 || !currentChatUser) {
                return;
            }

            const currentUserUid = localStorage.getItem("uid");
            if (!currentUserUid) {
                handleLogout();
                return;
            }

            setMessageInputState(false);

            try {
                const chatId = currentUserUid < currentChatUser.uid ? `${currentUserUid}_${currentChatUser.uid}` : `${currentChatUser.uid}_${currentUserUid}`;
                const messagesRef = collection(db, "chats", chatId, "messages");

                if (selectedFiles.length > 0) {
                    for (const file of selectedFiles) {
                        // For a real app, you would upload the file to Firebase Storage here
                        // and get a download URL. For this demo, we use FileReader.
                        const fileReader = new FileReader();
                        fileReader.onload = async (e) => {
                            await addDoc(messagesRef, {
                                text: text, // يمكن إرفاق نص مع الملف
                                sender: currentUserUid,
                                receiver: currentChatUser.uid,
                                createdAt: new Date(),
                                status: 'sent',
                                type: 'file',
                                fileName: file.name,
                                fileType: file.type,
                                fileSize: file.size,
                                fileUrl: e.target.result // Data URL for display (not for real storage)
                            });
                        };
                        fileReader.readAsDataURL(file); // Reads the file as a Data URL
                    }
                    showToastNotification(`تم إرسال ${selectedFiles.length} ملف${selectedFiles.length > 1 ? 'ات' : ''}.`, "success");
                } else {
                    // Send text message if no files are selected
                    await addDoc(messagesRef, {
                        text: text,
                        sender: currentUserUid,
                        receiver: currentChatUser.uid,
                        createdAt: new Date(),
                        status: 'sent',
                        type: 'text'
                    });
                    showToastNotification("تم إرسال الرسالة.", "success");
                }

                messageInput.value = "";
                selectedFiles = []; // مسح الملفات بعد الإرسال
                updateSendMessageButtonState(); // تحديث حالة الزر
            } catch (error) {
                console.error("خطأ في إرسال الرسالة/الملف:", error);
                alert("فشل إرسال الرسالة/الملف: " + error.message);
                showToastNotification("فشل إرسال الرسالة/الملف.", "error");
            } finally {
                setMessageInputState(true);
            }
        }

        // ===============================================
        // معالجة الملفات (تحديد الملف فقط حالياً)
        // ===============================================
        attachFileButton.addEventListener('click', () => {
            if (!currentChatUser) {
                showToastNotification("يرجى اختيار مستخدم للدردشة أولاً.", "info");
                return;
            }
            fileInput.click(); // يحفز النقر على عنصر إدخال الملفات المخفي
        });

        fileInput.addEventListener('change', (event) => {
            selectedFiles = Array.from(event.target.files);
            if (selectedFiles.length > 0) {
                const fileNames = selectedFiles.map(file => file.name).join(', ');
                showToastNotification(`تم تحديد الملفات: ${fileNames}. اضغط على زر الإرسال لإرسالها.`, "info", 5000);
            } else {
                showToastNotification("لم يتم تحديد أي ملفات.", "info");
            }
            updateSendMessageButtonState(); // تحديث حالة زر الإرسال
            fileInput.value = ''; // مسح تحديد الملف بعد المعالجة لتمكين تحديد نفس الملف مرة أخرى
        });

        messageInput.addEventListener('input', updateSendMessageButtonState);

        function updateSendMessageButtonState() {
            // تفعيل زر الإرسال إذا كان هناك نص أو ملفات محددة
            sendMessageButton.disabled = (messageInput.value.trim() === '' && selectedFiles.length === 0) || !currentChatUser;
        }


        // ===============================================
        // معالجة الأحداث عند تحميل التطبيق
        // ===============================================

        document.addEventListener("DOMContentLoaded", () => {
            const storedUid = localStorage.getItem("uid");
            if (storedUid) {
                currentUserId = storedUid;
                showSection("chat");
                setMessageInputState(false); // تعطيل زر الإرسال حتى يتم اختيار مستخدم
                updateSendMessageButtonState(); // تحديث الحالة الأولية
            } else {
                showSection("auth");
            }
        });

        // ربط الأحداث بالأزرار
        loginButton.addEventListener("click", handleLogin);
        logoutButton.addEventListener("click", handleLogout);
        sendMessageButton.addEventListener("click", sendMessage);


        // ربط زر "تسجيل مستخدم جديد" الرئيسي لفتح مودال التأكيد أولاً
        signupButton.addEventListener("click", showConfirmSignupModal);

        // أزرار مودال التأكيد
        confirmYesBtn.addEventListener("click", () => {
            hideConfirmSignupModal();
            showSignupModal();
        });

        confirmNoBtn.addEventListener("click", hideConfirmSignupModal);

        // ربط زر التسجيل داخل المودال
        modalRegisterButton.addEventListener("click", () => handleSignupLogic(true));

        // ربط زر إغلاق المودال
        signupModalCloseBtn.addEventListener("click", hideSignupModal);

        // إغلاق المودال عند النقر خارج المحتوى
        window.addEventListener("click", (event) => {
            if (event.target === signupModal) {
                hideSignupModal();
            }
            if (event.target === confirmSignupModal) {
                hideConfirmSignupModal();
            }
        });

        // ربط زر فتح وإغلاق القائمة الجانبية (المستخدمين)
        toggleUsersListButton.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);


        // إرسال الرسالة عند الضغط على Enter في حقل الإدخال
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === 'Enter' && !sendMessageButton.disabled) {
                sendMessage();
            }
        });

        // تشغيل تسجيل الدخول عند الضغط على Enter في حقول الواجهة الرئيسية
        usernameInput.addEventListener("keypress", (e) => {
            if (e.key === 'Enter' && !loginButton.disabled) {
                handleLogin();
            }
        });
        passwordInput.addEventListener("keypress", (e) => {
            if (e.key === 'Enter' && !loginButton.disabled) {
                handleLogin();
            }
        });

        // إرسال التسجيل من المودال عند الضغط على Enter في أي من حقول الإدخال بالمودال
        modalUsernameInput.addEventListener("keypress", (e) => {
            if (e.key === 'Enter' && !modalRegisterButton.disabled) {
                handleSignupLogic(true);
            }
        });
        modalPasswordInput.addEventListener("keypress", (e) => {
            if (e.key === 'Enter' && !modalRegisterButton.disabled) {
                handleSignupLogic(true);
            }
        });
        modalConfirmPasswordInput.addEventListener("keypress", (e) => {
            if (e.key === 'Enter' && !modalRegisterButton.disabled) {
                handleSignupLogic(true);
            }
        });
    </script>
</body>
</html>